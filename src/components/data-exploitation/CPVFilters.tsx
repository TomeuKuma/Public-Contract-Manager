import { useState, useEffect } from "react";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Card, CardContent } from "@/components/ui/card";
import { CONTRACTING_BODIES } from "@/lib/constants";
import { Button } from "@/components/ui/button";
import { CheckSquare, Square } from "lucide-react";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import { Slider } from "@/components/ui/slider";
import { supabase } from "@/integrations/supabase/client";

export interface CPVFiltersState {
    years: string[];
    topN: number;
    contractingBodies: string[];
    contractTypes: string[];
    awardProcedures: string[];
    hierarchyLevel: string; // "detailed", "2", "3", "4", "5"
    sortBy?: string;
}

interface CPVFiltersProps {
    onFiltersChange: (filters: CPVFiltersState) => void;
}

const CONTRACT_TYPES = ["Subministrament", "Servei", "Obra", "Concessió"];
const AWARD_PROCEDURES = ["Contracte obert", "Contracte menor AD", "Contracte menor ADO"];

const CPVFilters = ({ onFiltersChange }: CPVFiltersProps) => {
    const [filters, setFilters] = useState<CPVFiltersState>({
        years: [],
        topN: 10,
        contractingBodies: [],
        contractTypes: [],
        awardProcedures: [],
        hierarchyLevel: "detailed",
    });

    const [availableYears, setAvailableYears] = useState<string[]>([]);
    const [availableContractingBodies, setAvailableContractingBodies] = useState<string[]>([]);

    useEffect(() => {
        const fetchYears = async () => {
            // Query to get all distinct years from credits table
            // Use range to ensure we get enough records (Supabase limits by default)
            const { data, error } = await supabase
                .from('credits')
                .select('any')
                .range(0, 10000); // Fetch up to 10000 records to ensure we get all years

            if (error) {
                console.error("Error fetching years:", error);
            } else if (data) {
                // Extract unique years, filter out null/undefined, convert to strings, and sort descending
                const uniqueYears = [...new Set(data.map(d => d.any).filter(Boolean))];
                const sortedYears = uniqueYears
                    .map(year => String(year))
                    .sort((a, b) => Number(b) - Number(a));

                console.log("Available years found:", sortedYears);
                console.log("Total credit records scanned:", data.length);
                setAvailableYears(sortedYears);
            }
        };

        fetchYears();
        setAvailableContractingBodies(CONTRACTING_BODIES as unknown as string[]);
    }, []);

    useEffect(() => {
        onFiltersChange(filters);
    }, [filters, onFiltersChange]);

    const handleMultiSelectChange = (
        field: keyof CPVFiltersState,
        value: string,
        isChecked: boolean
    ) => {
        setFilters(prev => {
            const currentValues = prev[field] as string[];
            const newValues = isChecked
                ? [...currentValues, value]
                : currentValues.filter(item => item !== value);
            return { ...prev, [field]: newValues };
        });
    };

    const handleSelectAll = (field: keyof CPVFiltersState, options: string[]) => {
        setFilters(prev => ({ ...prev, [field]: options }));
    };

    const handleDeselectAll = (field: keyof CPVFiltersState) => {
        setFilters(prev => ({ ...prev, [field]: [] }));
    };

    const renderMultiSelect = (
        label: string,
        field: keyof CPVFiltersState,
        options: string[]
    ) => (
        <div className="space-y-2">
            <div className="flex items-center justify-between">
                <Label>{label}</Label>
                <div className="flex gap-1">
                    <Tooltip>
                        <TooltipTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-6 w-6" onClick={() => handleSelectAll(field, options)}>
                                <CheckSquare className="h-4 w-4 text-muted-foreground" />
                            </Button>
                        </TooltipTrigger>
                        <TooltipContent>Marcar tots</TooltipContent>
                    </Tooltip>
                    <Tooltip>
                        <TooltipTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-6 w-6" onClick={() => handleDeselectAll(field)}>
                                <Square className="h-4 w-4 text-muted-foreground" />
                            </Button>
                        </TooltipTrigger>
                        <TooltipContent>Desmarcar tots</TooltipContent>
                    </Tooltip>
                </div>
            </div>
            <Card>
                <CardContent className="p-0">
                    <ScrollArea className="h-[150px] p-4">
                        <div className="space-y-2">
                            {options.map((option) => (
                                <div key={option} className="flex items-center space-x-2">
                                    <Checkbox
                                        id={`${field}-${option}`}
                                        checked={(filters[field] as string[]).includes(option)}
                                        onCheckedChange={(checked) => handleMultiSelectChange(field, option, checked as boolean)}
                                    />
                                    <Label htmlFor={`${field}-${option}`} className="text-sm font-normal cursor-pointer">
                                        {option}
                                    </Label>
                                </div>
                            ))}
                        </div>
                    </ScrollArea>
                </CardContent>
            </Card>
        </div>
    );

    return (
        <div className="space-y-6">
            {/* Hierarchy Level */}
            <div className="space-y-2">
                <Label>Nivell de jerarquia</Label>
                <Select
                    value={filters.hierarchyLevel}
                    onValueChange={(val) => setFilters(prev => ({ ...prev, hierarchyLevel: val }))}
                >
                    <SelectTrigger>
                        <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="detailed">Detallat (Codi complet)</SelectItem>
                        <SelectItem value="2">Divisió (2 dígits)</SelectItem>
                        <SelectItem value="3">Grup (3 dígits)</SelectItem>
                        <SelectItem value="4">Classe (4 dígits)</SelectItem>
                        <SelectItem value="5">Categoria (5 dígits)</SelectItem>
                    </SelectContent>
                </Select>
            </div>

            {/* Top N Slider */}
            <div className="space-y-2">
                <Label>Mostrar Top {filters.topN}</Label>
                <div className="pt-2">
                    <Slider
                        value={[filters.topN]}
                        onValueChange={(vals) => setFilters(prev => ({ ...prev, topN: vals[0] }))}
                        min={5}
                        max={50}
                        step={5}
                        className="w-full"
                    />
                </div>
            </div>

            {/* Years Filter */}
            {renderMultiSelect("Anys", "years", availableYears)}

            {/* Contracting Body Filter */}
            {renderMultiSelect("Òrgan de contractació", "contractingBodies", availableContractingBodies)}

            {/* Contract Type Filter */}
            {renderMultiSelect("Tipus contractual", "contractTypes", CONTRACT_TYPES)}

            {/* Award Procedure Filter */}
            {renderMultiSelect("Procediment d'adjudicació", "awardProcedures", AWARD_PROCEDURES)}
        </div>
    );
};

export default CPVFilters;
