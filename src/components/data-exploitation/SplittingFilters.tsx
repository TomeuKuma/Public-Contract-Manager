import { useState, useEffect } from "react";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { ScrollArea } from "@/components/ui/scroll-area";
import { CPVSelector } from "@/components/cpv/CPVSelector";
import { CPVCode } from "@/types/cpv.types";
import { Card, CardContent } from "@/components/ui/card";
import { CONTRACTING_BODIES } from "@/lib/constants";
import { Button } from "@/components/ui/button";
import { CheckSquare, Square } from "lucide-react";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";

import { Input } from "@/components/ui/input";

interface SplittingFiltersProps {
    onFiltersChange: (filters: SplittingFiltersState) => void;
}

export interface SplittingFiltersState {
    contractingBodies: string[];
    needType: "Puntual" | "Recurrent" | "";
    cpv: CPVCode | null;
    queryDate: string;
}

const SplittingFilters = ({ onFiltersChange }: SplittingFiltersProps) => {
    const [filters, setFilters] = useState<SplittingFiltersState>({
        contractingBodies: [],
        needType: "",
        cpv: null,
        queryDate: new Date().toISOString().split('T')[0], // Default to today
    });

    // Use all official contracting bodies directly
    const availableContractingBodies = CONTRACTING_BODIES;

    // Update parent when filters change
    useEffect(() => {
        onFiltersChange(filters);
    }, [filters, onFiltersChange]);

    const handleContractingBodyChange = (body: string, checked: boolean) => {
        setFilters(prev => ({
            ...prev,
            contractingBodies: checked
                ? [...prev.contractingBodies, body]
                : prev.contractingBodies.filter(b => b !== body)
        }));
    };

    const handleSelectAll = () => {
        setFilters(prev => ({
            ...prev,
            contractingBodies: [...availableContractingBodies]
        }));
    };

    const handleDeselectAll = () => {
        setFilters(prev => ({
            ...prev,
            contractingBodies: []
        }));
    };

    return (
        <div className="space-y-6">
            {/* Contracting Body Selector */}
            <div className="space-y-2">
                <div className="flex items-center justify-between">
                    <Label>Òrgan de contractació</Label>
                    <div className="flex gap-1">
                        <Tooltip>
                            <TooltipTrigger asChild>
                                <Button variant="ghost" size="icon" className="h-6 w-6" onClick={handleSelectAll}>
                                    <CheckSquare className="h-4 w-4 text-muted-foreground" />
                                </Button>
                            </TooltipTrigger>
                            <TooltipContent>Marcar tots</TooltipContent>
                        </Tooltip>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                <Button variant="ghost" size="icon" className="h-6 w-6" onClick={handleDeselectAll}>
                                    <Square className="h-4 w-4 text-muted-foreground" />
                                </Button>
                            </TooltipTrigger>
                            <TooltipContent>Desmarcar tots</TooltipContent>
                        </Tooltip>
                    </div>
                </div>
                <Card>
                    <CardContent className="p-0">
                        <ScrollArea className="h-[200px] p-4">
                            <div className="space-y-2">
                                {availableContractingBodies.map((body) => (
                                    <div key={body} className="flex items-center space-x-2">
                                        <Checkbox
                                            id={`body-${body}`}
                                            checked={filters.contractingBodies.includes(body)}
                                            onCheckedChange={(checked) => handleContractingBodyChange(body, checked as boolean)}
                                        />
                                        <Label htmlFor={`body-${body}`} className="text-sm font-normal cursor-pointer">
                                            {body}
                                        </Label>
                                    </div>
                                ))}
                            </div>
                        </ScrollArea>
                    </CardContent>
                </Card>
            </div>

            {/* Query Date Selector */}
            <div className="space-y-2">
                <Label>Data de consulta</Label>
                <Input
                    type="date"
                    value={filters.queryDate}
                    onChange={(e) => setFilters(prev => ({ ...prev, queryDate: e.target.value }))}
                />
            </div>

            {/* Need Type Selector */}
            <div className="space-y-2">
                <Label>Tipus de necessitat</Label>
                <Select
                    value={filters.needType}
                    onValueChange={(value: "Puntual" | "Recurrent") => setFilters(prev => ({ ...prev, needType: value }))}
                >
                    <SelectTrigger>
                        <SelectValue placeholder="Selecciona tipus" />
                    </SelectTrigger>
                    <SelectContent>
                        <SelectItem value="Puntual">Puntual</SelectItem>
                        <SelectItem value="Recurrent">Recurrent</SelectItem>
                    </SelectContent>
                </Select>
            </div>

            {/* CPV Selector */}
            <div className="space-y-2">
                <Label>Codi CPV</Label>
                <Popover>
                    <PopoverTrigger asChild>
                        <Button variant="outline" className="w-full justify-start text-left font-normal">
                            {filters.cpv ? (
                                <span className="truncate">
                                    <span className="font-bold mr-2">{filters.cpv.code}</span>
                                    {filters.cpv.description_ca}
                                </span>
                            ) : (
                                <span className="text-muted-foreground">Seleccionar CPV...</span>
                            )}
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent className="w-[600px] p-0" align="start">
                        <CPVSelector
                            onSelect={(cpv) => setFilters(prev => ({ ...prev, cpv }))}
                            selectedId={filters.cpv?.id}
                            className="border-0"
                        />
                    </PopoverContent>
                </Popover>
            </div>
        </div>
    );
};

export default SplittingFilters;
