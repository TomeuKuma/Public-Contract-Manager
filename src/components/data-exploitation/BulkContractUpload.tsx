import { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Progress } from "@/components/ui/progress";
import { Download, Upload, FileSpreadsheet, CheckCircle2, XCircle, AlertCircle } from "lucide-react";
import { generateTemplate, parseExcelFile, processUpload, ValidationError } from "@/lib/bulkUploadService";
import { useToast } from "@/hooks/use-toast";

const BulkContractUpload = () => {
    const [uploading, setUploading] = useState(false);
    const [progress, setProgress] = useState(0);
    const [result, setResult] = useState<{
        success: boolean;
        contractsCreated: number;
        lotsCreated: number;
        errors: ValidationError[];
    } | null>(null);
    const { toast } = useToast();

    const handleDownloadTemplate = () => {
        try {
            generateTemplate();
            toast({
                title: "Plantilla descarregada",
                description: "La plantilla s'ha descarregat correctament.",
            });
        } catch (error) {
            toast({
                title: "Error",
                description: "No s'ha pogut descarregar la plantilla.",
                variant: "destructive",
            });
        }
    };

    const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        // Validate file type
        if (!file.name.endsWith(".xlsx") && !file.name.endsWith(".xls")) {
            toast({
                title: "Format invàlid",
                description: "Si us plau, selecciona un fitxer Excel (.xlsx o .xls).",
                variant: "destructive",
            });
            return;
        }

        setUploading(true);
        setProgress(10);
        setResult(null);

        try {
            // Parse Excel file
            setProgress(30);
            const rows = await parseExcelFile(file);

            if (rows.length === 0) {
                toast({
                    title: "Fitxer buit",
                    description: "El fitxer no conté dades per processar.",
                    variant: "destructive",
                });
                setUploading(false);
                return;
            }

            // Process upload
            setProgress(50);
            const uploadResult = await processUpload(rows);
            setProgress(100);
            setResult(uploadResult);

            if (uploadResult.success) {
                toast({
                    title: "Càrrega completada",
                    description: `S'han creat ${uploadResult.contractsCreated} contractes i ${uploadResult.lotsCreated} lots.`,
                });
            } else {
                toast({
                    title: "Càrrega amb errors",
                    description: `S'han trobat ${uploadResult.errors.length} errors. Revisa els detalls a continuació.`,
                    variant: "destructive",
                });
            }
        } catch (error: any) {
            toast({
                title: "Error processant el fitxer",
                description: error.message || "S'ha produït un error inesperat.",
                variant: "destructive",
            });
        } finally {
            setUploading(false);
            // Reset file input
            event.target.value = "";
        }
    };

    return (
        <div className="space-y-6">
            <Card>
                <CardHeader>
                    <CardTitle>Càrrega massiva AD/ADO</CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                    {/* Instructions */}
                    <Alert>
                        <AlertCircle className="h-4 w-4" />
                        <AlertDescription>
                            <div className="space-y-2">
                                <p className="font-semibold">Instruccions:</p>
                                <ol className="list-decimal list-inside space-y-1 text-sm">
                                    <li>Descarrega la plantilla Excel fent clic al botó de sota</li>
                                    <li>Omple la plantilla amb les dades dels contractes i lots</li>
                                    <li>Els camps marcats amb * són obligatoris</li>
                                    <li>Cada fila representa un lot (o "Sense lot" si no hi ha lots)</li>
                                    <li>Puja el fitxer completat utilitzant el botó de càrrega</li>
                                </ol>
                            </div>
                        </AlertDescription>
                    </Alert>

                    {/* Template Download */}
                    <div className="flex flex-col sm:flex-row gap-4">
                        <Button
                            onClick={handleDownloadTemplate}
                            variant="outline"
                            className="flex-1"
                        >
                            <Download className="mr-2 h-4 w-4" />
                            Descarregar plantilla
                        </Button>

                        {/* File Upload */}
                        <label className="flex-1">
                            <Button
                                disabled={uploading}
                                className="w-full"
                                asChild
                            >
                                <span>
                                    <Upload className="mr-2 h-4 w-4" />
                                    {uploading ? "Processant..." : "Carregar fitxer Excel"}
                                </span>
                            </Button>
                            <input
                                type="file"
                                accept=".xlsx,.xls"
                                onChange={handleFileUpload}
                                disabled={uploading}
                                className="hidden"
                            />
                        </label>
                    </div>

                    {/* Progress */}
                    {uploading && (
                        <div className="space-y-2">
                            <Progress value={progress} />
                            <p className="text-sm text-muted-foreground text-center">
                                Processant fitxer... {progress}%
                            </p>
                        </div>
                    )}

                    {/* Results */}
                    {result && (
                        <div className="space-y-4">
                            {result.success ? (
                                <Alert className="border-green-500 bg-green-50">
                                    <CheckCircle2 className="h-4 w-4 text-green-600" />
                                    <AlertDescription className="text-green-800">
                                        <div className="space-y-1">
                                            <p className="font-semibold">Càrrega completada amb èxit!</p>
                                            <p className="text-sm">
                                                Contractes creats: {result.contractsCreated}
                                            </p>
                                            <p className="text-sm">
                                                Lots creats: {result.lotsCreated}
                                            </p>
                                        </div>
                                    </AlertDescription>
                                </Alert>
                            ) : (
                                <Alert variant="destructive">
                                    <XCircle className="h-4 w-4" />
                                    <AlertDescription>
                                        <div className="space-y-2">
                                            <p className="font-semibold">
                                                S'han trobat {result.errors.length} errors:
                                            </p>
                                            <div className="max-h-60 overflow-y-auto space-y-1">
                                                {result.errors.map((error, index) => (
                                                    <div key={index} className="text-sm bg-white/50 p-2 rounded">
                                                        <span className="font-medium">Fila {error.row}:</span>{" "}
                                                        {error.field} - {error.message}
                                                    </div>
                                                ))}
                                            </div>
                                            {result.contractsCreated > 0 && (
                                                <p className="text-sm mt-2">
                                                    Tot i els errors, s'han creat {result.contractsCreated} contractes
                                                    i {result.lotsCreated} lots correctament.
                                                </p>
                                            )}
                                        </div>
                                    </AlertDescription>
                                </Alert>
                            )}
                        </div>
                    )}

                    {/* Template Info */}
                    <div className="border rounded-lg p-4 bg-muted/50">
                        <div className="flex items-start gap-3">
                            <FileSpreadsheet className="h-5 w-5 text-muted-foreground mt-0.5" />
                            <div className="space-y-2 text-sm">
                                <p className="font-semibold">Format de la plantilla:</p>
                                <ul className="list-disc list-inside space-y-1 text-muted-foreground">
                                    <li>Una fila per lot (o contracte sense lots)</li>
                                    <li>Contractes amb el mateix "Núm. d'expedient" s'agrupen</li>
                                    <li>Dates en format DD/MM/YYYY</li>
                                    <li>Àrees i centres separats per comes</li>
                                    <li>Tipus de contracte: Servei, Subministrament o Obra</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
};

export default BulkContractUpload;
