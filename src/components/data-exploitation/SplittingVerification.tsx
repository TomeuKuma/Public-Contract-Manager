import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { SplittingFiltersState } from "./SplittingFilters";
import { useSplittingAnalysis } from "@/hooks/useSplittingAnalysis";
import { Loader2, AlertCircle } from "lucide-react";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { FractionationDetailsTable } from "../exploitation/FractionationDetailsTable";
import { FractionationFilters } from "@/lib/exploitationService";

interface SplittingVerificationProps {
    filters: SplittingFiltersState | null;
}

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

const SplittingVerification = ({ filters }: SplittingVerificationProps) => {
    const { data: result, isLoading, error, isFetched } = useSplittingAnalysis(
        filters || { contractingBodies: [], needType: "", cpv: null, queryDate: "" },
        !!filters
    );

    if (!filters) {
        return (
            <Card>
                <CardContent className="p-8 text-center text-muted-foreground">
                    Selecciona els filtres i prem "Anàlisi de fraccionament" per veure els resultats.
                </CardContent>
            </Card>
        );
    }

    if (isLoading) {
        return (
            <div className="flex justify-center items-center h-[400px]">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    if (error) {
        return (
            <Alert variant="destructive">
                <AlertCircle className="h-4 w-4" />
                <AlertTitle>Error</AlertTitle>
                <AlertDescription>
                    Hi ha hagut un error carregant les dades: {(error as Error).message}
                </AlertDescription>
            </Alert>
        );
    }

    const chartData = result?.data || [];
    const stats = result?.debugStats;

    if (isFetched && (!chartData || chartData.length === 0 || chartData.every(d => d.totalCommitted === 0))) {
        return (
            <div className="space-y-4">
                <Card>
                    <CardContent className="p-8 text-center text-muted-foreground">
                        No s'han trobat dades amb els filtres seleccionats.
                    </CardContent>
                </Card>
                {stats && stats.lotExistsWithoutCredit && (
                    <Alert variant="default" className="border-yellow-500 bg-yellow-50 dark:bg-yellow-900/10">
                        <AlertCircle className="h-4 w-4 text-yellow-600" />
                        <AlertTitle className="text-yellow-700 dark:text-yellow-500">Atenció: Dades incompletes</AlertTitle>
                        <AlertDescription className="text-yellow-700/90 dark:text-yellow-500/90 mt-2">
                            S'han trobat lots a la base de dades que coincideixen amb el CPV seleccionat,
                            però <strong>no tenen crèdits (anualitats) assignats</strong> per al període seleccionat.
                            <br /><br />
                            Perquè apareguin al gràfic, has d'anar a la fitxa del contracte i afegir una anualitat al lot corresponent.
                        </AlertDescription>
                    </Alert>
                )}
                {stats && (
                    <Alert>
                        <AlertCircle className="h-4 w-4" />
                        <AlertTitle>Diagnòstic de l'anàlisi</AlertTitle>
                        <AlertDescription className="mt-2">
                            <ul className="list-disc pl-4 space-y-1 text-sm">
                                <li>Registres totals recuperats (últims 5 anys): <strong>{stats.totalFetched}</strong></li>
                                <li>Coincidències d'any ({filters.needType}): <strong>{stats.yearMatches}</strong> (Descartats: {stats.droppedReasons.yearMismatch})</li>
                                <li>
                                    Coincidències de CPV: <strong>{stats.cpvMatches}</strong> (Descartats: {stats.droppedReasons.cpvMismatch})
                                    <br />
                                    <span className="text-xs text-muted-foreground">
                                        Filtre (Prefix): "{stats.filterPrefixUsed}" vs Exemple DB: "{stats.sampleDbCPV}"
                                    </span>
                                </li>
                                <li>Coincidències d'Òrgan: <strong>{stats.bodyMatches}</strong> (Descartats: {stats.droppedReasons.bodyMismatch})</li>
                                <li><strong>Coincidències Finals: {stats.finalMatches}</strong></li>
                            </ul>
                            {stats.availableCPVs && stats.availableCPVs.length > 0 && (
                                <div className="mt-4 pt-4 border-t border-border">
                                    <p className="text-sm font-semibold mb-2">CPVs disponibles en les dades recuperades ({stats.availableCPVs.length}):</p>
                                    <div className="flex flex-wrap gap-2 max-h-[200px] overflow-y-auto">
                                        {stats.availableCPVs.map((cpv, i) => (
                                            <code key={i} className="bg-muted px-2 py-1 rounded text-xs select-all cursor-pointer hover:bg-muted/80" title="Clica per copiar" onClick={() => navigator.clipboard.writeText(cpv)}>
                                                {cpv}
                                            </code>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </AlertDescription>
                    </Alert>
                )}
            </div>
        );
    }

    return (
        <div className="space-y-4">
            <Card className="h-full">
                <CardHeader>
                    <CardTitle>Resultats de l'anàlisi</CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="h-[500px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart
                                layout="vertical"
                                data={chartData}
                                margin={{
                                    top: 20,
                                    right: 30,
                                    left: 100, // Increase left margin for labels
                                    bottom: 5,
                                }}
                            >
                                <CartesianGrid strokeDasharray="3 3" horizontal={false} vertical={true} />
                                <XAxis type="number" />
                                <YAxis
                                    dataKey="contractingBody"
                                    type="category"
                                    width={150}
                                    tick={{ fontSize: 12 }}
                                />
                                <Tooltip
                                    formatter={(value: number) =>
                                        new Intl.NumberFormat('ca-ES', { style: 'currency', currency: 'EUR' }).format(value)
                                    }
                                />
                                <Legend />
                                <Bar dataKey="totalCommitted" name="Crèdit Compromès" fill="#8884d8">
                                    {chartData?.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                    ))}
                                </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </CardContent>
            </Card>

            <FractionationDetailsTable
                filters={filters as FractionationFilters}
                showResults={true}
            />
        </div>
    );
};

export default SplittingVerification;
