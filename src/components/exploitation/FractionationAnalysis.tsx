import { useEffect, useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from "recharts";
import { getFractionationData, FractionationFilters, FractionationResult } from "@/lib/exploitationService";
import { Loader2 } from "lucide-react";

interface FractionationAnalysisProps {
    filters: FractionationFilters;
    showResults: boolean;
}

const COLORS = [
    "#8884d8",
    "#82ca9d",
    "#ffc658",
    "#ff7c7c",
    "#a78bfa",
    "#fb923c",
    "#34d399",
    "#60a5fa",
];

const FractionationAnalysis = ({ filters, showResults }: FractionationAnalysisProps) => {
    const [data, setData] = useState<FractionationResult[]>([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!showResults) {
            setData([]);
            return;
        }

        const fetchData = async () => {
            setLoading(true);
            try {
                const results = await getFractionationData(filters);
                setData(results);
            } catch (error) {
                console.error("Error fetching fractionation data:", error);
            } finally {
                setLoading(false);
            }
        };

        fetchData();
    }, [filters, showResults]);

    if (!showResults) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle>Verificació de fraccionament</CardTitle>
                    <CardDescription>
                        Selecciona els filtres i fes clic a "Anàlisi de fraccionament" per veure els resultats
                    </CardDescription>
                </CardHeader>
            </Card>
        );
    }

    if (!filters.cpv) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle>CPV obligatori</CardTitle>
                    <CardDescription>
                        Si us plau, selecciona un codi CPV per realitzar l'anàlisi de fraccionament
                    </CardDescription>
                </CardHeader>
            </Card>
        );
    }

    if (loading) {
        return (
            <Card>
                <CardContent className="flex items-center justify-center py-12">
                    <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                </CardContent>
            </Card>
        );
    }

    if (data.length === 0) {
        return (
            <Card>
                <CardHeader>
                    <CardTitle>Sense resultats</CardTitle>
                    <CardDescription>
                        No s'han trobat dades amb els filtres seleccionats
                    </CardDescription>
                </CardHeader>
            </Card>
        );
    }

    const formatCurrency = (value: number) => {
        return new Intl.NumberFormat("ca-ES", {
            style: "currency",
            currency: "EUR",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(value);
    };

    return (
        <Card>
            <CardHeader>
                <CardTitle>Resultat: Verificació de fraccionament</CardTitle>
                <CardDescription>
                    Sumatori de crèdit compromès per òrgan de contractació
                    {filters.cpv && ` - CPV: ${filters.cpv.code} ${filters.cpv.description_ca}`}
                </CardDescription>
            </CardHeader>
            <CardContent>
                <ResponsiveContainer width="100%" height={400}>
                    <BarChart data={data} layout="vertical" margin={{ top: 5, right: 30, left: 150, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" tickFormatter={formatCurrency} />
                        <YAxis dataKey="contracting_body" type="category" width={140} />
                        <Tooltip
                            formatter={(value: number) => formatCurrency(value)}
                            labelStyle={{ color: "#000" }}
                        />
                        <Bar dataKey="total_committed" name="Crèdit Compromès">
                            {data.map((entry, index) => (
                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                            ))}
                        </Bar>
                    </BarChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
    );
};

export default FractionationAnalysis;
